<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Precision Clock Todo - Repeat & Alarm</title>

<style>
:root {
    --bg:#f9fafb;
    --panel:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --accent:#ef4444;
    --border:#e5e7eb;
}

* { box-sizing: border-box; }

html, body {
    margin: 0;
    height: 100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
}

.container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    height: 100vh;
}

/* ===== CLOCK ===== */
.clock {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.clock-time {
    font-size: clamp(6rem, 15vw, 12rem);
    font-weight: 600;
    letter-spacing: -0.05em;
}

.clock-date {
    margin-top: 8px;
    font-size: 1rem;
    color: var(--muted);
    letter-spacing: 0.08em;
}

/* ===== TODOS ===== */
.todos {
    border-left: 1px solid var(--border);
    padding: 24px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.todos header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.todos h2 {
    font-size: 0.85rem;
    letter-spacing: 0.12em;
    color: var(--muted);
}

button {
    background: none;
    border: 1px solid var(--border);
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

button:hover { background: #f3f4f6; }

.fullscreen-btn {
    border: 1px solid var(--border);
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    background: none;
}

.todo-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* ===== TODO ITEM ===== */
.todo {
    padding: 14px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--panel);
    position: relative;
    transition: all 0.3s ease;
}

.todo header {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 4px;
}

.todo h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 500;
}

/* ALERT ANIMATION */
@keyframes subtleShake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    50% { transform: translateX(2px); }
    75% { transform: translateX(-2px); }
    100% { transform: translateX(0); }
}

.todo.alert {
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(239,68,68,0.2);
    background: #fffafa;
    animation: subtleShake 0.4s ease-in-out infinite;
}

/* ===== MODAL ===== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.modal.active { display: flex; }

.modal-content {
    background: var(--panel);
    border-radius: 16px;
    padding: 24px;
    width: 340px;
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.modal-content input {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    width: 100%;
}

.repeat-options {
    font-size: 0.85rem;
    display: flex;
    gap: 10px;
}

.weekday-selector {
    display: none;
    gap: 4px;
    flex-wrap: wrap;
    padding: 8px;
    background: #f9fafb;
    border-radius: 8px;
}

/* Pseudo-fullscreen for iPad */
.pseudo-fullscreen {
    position: fixed !important;
    inset: 0 !important;
    z-index: 9999 !important;
    background: var(--bg) !important;
}
</style>
</head>

<body>
<div class="container" id="mainContainer">
    <div class="clock">
        <div class="clock-time" id="clockTime">--:--</div>
        <div class="clock-date" id="clockDate">----.--.-- ---</div>
    </div>

    <div class="todos">
        <header>
            <h2>TODOS</h2>
            <div style="display:flex;gap:8px;">
                <button onclick="openModal()">＋ Add</button>
                <button id="fullscreenBtn" onclick="toggleFullscreen()">全画面</button>
            </div>
        </header>
        <div class="todo-list" id="todoList"></div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3>New Alarm</h3>
        <input id="titleInput" type="text" placeholder="内容を入力...">
        
        <div class="repeat-options">
            <label><input type="radio" name="repeatType" value="once" checked onchange="toggleRepeatUI()"> 1回</label>
            <label><input type="radio" name="repeatType" value="daily" onchange="toggleRepeatUI()"> 毎日</label>
            <label><input type="radio" name="repeatType" value="weekly" onchange="toggleRepeatUI()"> 曜日</label>
        </div>

        <div id="dateInputContainer">
            <input type="date" id="dateInput">
        </div>

        <div id="weekdayInputContainer" class="weekday-selector">
            <label><input type="checkbox" class="wd-check" value="1">月</label>
            <label><input type="checkbox" class="wd-check" value="2">火</label>
            <label><input type="checkbox" class="wd-check" value="3">水</label>
            <label><input type="checkbox" class="wd-check" value="4">木</label>
            <label><input type="checkbox" class="wd-check" value="5">金</label>
            <label><input type="checkbox" class="wd-check" value="6">土</label>
            <label><input type="checkbox" class="wd-check" value="0">日</label>
        </div>

        <input type="time" id="timeInput">

        <div style="display:flex;justify-content:flex-end;gap:8px;">
            <button onclick="closeModal()">Cancel</button>
            <button onclick="saveTodo()" style="background:var(--text);color:white;">Save</button>
        </div>
    </div>
</div>

<script>
let todos = JSON.parse(localStorage.getItem("todos") || "[]");
let alarmInterval = null;

/* ===== CLOCK ===== */
function updateClock() {
    const d = new Date();
    document.getElementById("clockTime").textContent = 
        `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    const days = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
    document.getElementById("clockDate").textContent =
        `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,"0")}.${String(d.getDate()).padStart(2,"0")} ${days[d.getDay()]}`;
}
setInterval(updateClock, 1000);
updateClock();

/* ===== CALCULATION LOGIC (MS Based) ===== */
function calculateNextTrigger(repeatType, timeStr, dateStr, weekdays) {
    const [hrs, mins] = timeStr.split(':').map(Number);
    let target = new Date();
    
    if (repeatType === "once") {
        target = new Date(`${dateStr}T${timeStr}:00`);
        return target.getTime();
    }

    target.setHours(hrs, mins, 0, 0);
    
    // すでに今日の時刻を過ぎていたら明日以降を探す
    if (target.getTime() <= Date.now()) {
        target.setDate(target.getDate() + 1);
    }

    if (repeatType === "weekly") {
        while (!weekdays.includes(target.getDay())) {
            target.setDate(target.getDate() + 1);
        }
    }
    return target.getTime();
}

/* ===== ACTIONS ===== */
function render() {
    const list = document.getElementById("todoList");
    list.innerHTML = "";
    // 未来の実行時刻が近い順にソート
    todos.sort((a, b) => a.nextTriggerTime - b.nextTriggerTime);

    todos.forEach(t => {
        const el = document.createElement("div");
        el.className = "todo" + (t.notified ? " alert" : "");
        
        let schedule = "";
        if (t.repeatType === "once") schedule = t.date;
        else if (t.repeatType === "daily") schedule = "毎日";
        else schedule = t.weekdays.map(d => ["日","月","火","水","木","金","土"][d]).join("");

        el.innerHTML = `
            <header>
                <span>${schedule} ${t.time}</span>
                <span style="cursor:pointer;font-weight:bold;padding:0 5px;" onclick="handleAction(${t.id})">
                    ${t.notified ? "停止" : "×"}
                </span>
            </header>
            <h3>${t.title}</h3>
        `;
        list.appendChild(el);
    });
}

function handleAction(id) {
    const idx = todos.findIndex(t => t.id === id);
    if (idx === -1) return;
    const t = todos[idx];

    if (t.notified && (t.repeatType === "daily" || t.repeatType === "weekly")) {
        // 繰り返し設定の場合は、次回の実行時刻を再計算してリセット
        t.notified = false;
        t.nextTriggerTime = calculateNextTrigger(t.repeatType, t.time, t.date, t.weekdays);
    } else {
        // 1回切り、または未発火の削除
        todos.splice(idx, 1);
    }

    saveAndRender();
    if (!todos.some(t => t.notified)) stopAlarmSound();
}

function saveAndRender() {
    localStorage.setItem("todos", JSON.stringify(todos));
    render();
}

/* ===== MONITORING ===== */
function checkTodos() {
    const now = Date.now();
    let changed = false;

    todos.forEach(t => {
        if (!t.notified && now >= t.nextTriggerTime) {
            t.notified = true;
            changed = true;
            if (Notification.permission === "granted") {
                new Notification("Time to: " + t.title);
            }
        }
    });

    if (todos.some(t => t.notified)) playAlarmSound();
    if (changed) saveAndRender();
}
setInterval(checkTodos, 1000);

/* ===== MODAL & SOUND (Same as before but integrated) ===== */
function openModal() {
    const now = new Date();
    document.getElementById("titleInput").value = "";
    document.getElementById("dateInput").value = now.toISOString().split("T")[0];
    document.getElementById("timeInput").value = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
    document.getElementById("modal").classList.add("active");
}
function closeModal() { document.getElementById("modal").classList.remove("active"); }
function toggleRepeatUI() {
    const type = document.querySelector('input[name="repeatType"]:checked').value;
    document.getElementById("dateInputContainer").style.display = (type === "once") ? "block" : "none";
    document.getElementById("weekdayInputContainer").style.display = (type === "weekly") ? "flex" : "none";
}

function saveTodo() {
    const title = document.getElementById("titleInput").value;
    const type = document.querySelector('input[name="repeatType"]:checked').value;
    const time = document.getElementById("timeInput").value;
    const date = document.getElementById("dateInput").value;
    if (!title || !time) return;

    let weekdays = [];
    if (type === "weekly") {
        document.querySelectorAll(".wd-check:checked").forEach(el => weekdays.push(parseInt(el.value)));
        if (weekdays.length === 0) return alert("曜日を選択してください");
    }

    const nextMs = calculateNextTrigger(type, time, date, weekdays);

    todos.push({
        id: Date.now(),
        title,
        repeatType: type,
        date,
        weekdays,
        time,
        nextTriggerTime: nextMs,
        notified: false
    });

    saveAndRender();
    closeModal();
}

function playAlarmSound() {
    if (alarmInterval) return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const beep = () => {
        [0, 0.2].forEach(d => {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'square';
            o.frequency.setValueAtTime(880, ctx.currentTime + d);
            g.gain.setValueAtTime(0.1, ctx.currentTime + d);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + d + 0.1);
            o.connect(g); g.connect(ctx.destination);
            o.start(ctx.currentTime + d); o.stop(ctx.currentTime + d + 0.1);
        });
    };
    beep();
    alarmInterval = setInterval(beep, 1500);
}

function stopAlarmSound() {
    if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
}

/* ===== FULLSCREEN ===== */
function toggleFullscreen() {
    const el = document.documentElement;
    const isFS = document.fullscreenElement || document.webkitFullscreenElement;
    if (isFS) {
        const exit = document.exitFullscreen || document.webkitExitFullscreen;
        if (exit) exit.call(document);
        document.body.classList.remove('pseudo-fullscreen');
    } else {
        const req = el.requestFullscreen || el.webkitRequestFullscreen;
        if (req) req.call(el).catch(() => document.body.classList.add('pseudo-fullscreen'));
        else document.body.classList.add('pseudo-fullscreen');
    }
}

document.addEventListener('fullscreenchange', () => {
    document.getElementById('fullscreenBtn').textContent = document.fullscreenElement ? '戻る' : '全画面';
});

if (window.Notification) Notification.requestPermission();
render();
</script>
</body>
</html>
